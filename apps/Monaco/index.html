<!DOCTYPE html >
<html lang="ru">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" href="./min/vs/editor/editor.main.css" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: sans-serif;
        }
        #container {
            width: 100%;
            height: 100%;
        }
        #editor {
            width: 100%;
            height: 100%;
        }
    </style>
    <title>Monaco Editor</title>
</head>
<body>
<div id="container">
    <div id="editor"></div>
</div>

<script src="./min/vs/loader.js"></script>

<script>
    require.config({
        paths: {
            'vs': new URL('./min/vs', window.location).href
        }
    });

    let editor;
    let isInitializing = false;
    let isInitialized = false;
    let pendingUpdate = null;

    function initMonaco() {
        if (isInitialized || isInitializing) {
            return Promise.resolve(editor);
        }

        isInitializing = true;
        
        return new Promise((resolve, reject) => {
            require([
                'vs/editor/editor.main'
            ], function() {
                if (isInitialized) {
                    resolve(editor);
                    return;
                }

                const editorElement = document.getElementById('editor');
                
                editorElement.innerHTML = '';
                
                const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches 
                    ? 'vs-dark' 
                    : 'vs-light';
                
                try {
                    editor = monaco.editor.create(editorElement, {
                        value: '// Ready\n',
                        language: 'go',
                        theme: systemTheme,
                        automaticLayout: true,
                        minimap: { enabled: false },
                        scrollBeyondLastLine: false
                    });

                    isInitialized = true;
                    isInitializing = false;
                    console.log('Monaco initialized');

                    if (pendingUpdate) {
                        updateContent(pendingUpdate.content, pendingUpdate.language);
                        pendingUpdate = null;
                    }

                    resolve(editor);
                } catch (e) {
                    isInitializing = false;
                    console.error('Monaco init error:', e);
                    reject(e);
                }
            });
        });
    }

    function updateContent(content, language) {
        if (!isInitialized) {
            console.warn('Editor not initialized yet');
            pendingUpdate = { content, language };
            initMonaco();
            return;
        }

        try {
            if (content !== undefined) {
                editor.setValue(content || '');
            }
            if (language) {
                const model = editor.getModel();
                if (model) {
                    monaco.editor.setModelLanguage(model, language);
                }
            }
        } catch (e) {
            console.error('Update error:', e);
        }
    }

    initMonaco();
</script>
</body>
</html>
